<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <title>Jaroslav's Game & Hardware Collectie</title>
    <script src="xlsx.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #121212; color: #e0e0e0; margin: 0; padding: 20px; overflow-x: hidden; }
        .container { max-width: 1100px; margin: 0 auto; text-align: center; transition: margin-left 0.3s; }
        
        /* Layout Switcher */
        .layout-switch { position: fixed; top: 20px; right: 20px; z-index: 1500; display: none; gap: 5px; background: #1a1a1a; padding: 5px; border-radius: 8px; border: 1px solid #333; }
        .switch-btn { background: transparent; color: #888; border: none; padding: 8px 12px; cursor: pointer; border-radius: 5px; font-weight: bold; transition: 0.3s; }
        .switch-btn.active { background: #00ffcc; color: #121212; }

        /* Sidebar */
        .sidebar { height: 100%; width: 0; position: fixed; z-index: 1000; top: 0; left: 0; background-color: #1a1a1a; overflow-x: hidden; transition: 0.3s; padding-top: 60px; border-right: 1px solid #333; text-align: left; }
        .sidebar-content { padding: 20px; min-width: 310px; }
        .closebtn { position: absolute; top: 10px; right: 25px; font-size: 36px; color: #888; text-decoration: none; cursor: pointer; }
        .openbtn { font-size: 18px; cursor: pointer; background-color: #1e1e1e; color: #00ffcc; padding: 10px 15px; border: 1px solid #333; border-radius: 8px; position: fixed; top: 20px; left: 20px; z-index: 999; }
        #sidebar-summary table { width: 100%; border-collapse: collapse; }
        #sidebar-summary th, #sidebar-summary td { padding: 10px 5px; border-bottom: 1px solid #333; text-align: left; }

        /* Familie Kleuren */
        .ps-group { border-left-color: #0056e0 !important; }
        .tab-button.ps-active { background: #0056e0 !important; color: white !important; }
        .ps-text { color: #0056e0 !important; }
        .nintendo-group { border-left-color: #e60012 !important; }
        .tab-button.nintendo-active { background: #e60012 !important; color: white !important; }
        .nintendo-text { color: #e60012 !important; }
        .xbox-group { border-left-color: #107c10 !important; }
        .tab-button.xbox-active { background: #107c10 !important; color: white !important; }
        .xbox-text { color: #107c10 !important; }
        .pc-group { border-left-color: #616161 !important; }
        .tab-button.pc-active { background: #616161 !important; color: white !important; }
        .pc-text { color: #616161 !important; }
        .hardware-group { border-left-color: #ffcc00 !important; }
        .tab-button.hardware-active { background: #ffcc00 !important; color: #000 !important; }
        .hardware-text { color: #ffcc00 !important; }

        /* Console Titels */
        .group-section h3 { 
            color: #ffffff !important; 
            font-size: 1.5em; 
            font-weight: bold; 
            margin-bottom: 15px;
            text-align: left;
        }
        .group-section { 
            margin-bottom: 40px !important; 
            padding-left: 15px;
        }

        /* Filter Kleuren */
        .ps-active-style .filter-btn.active { background: #0056e0 !important; color: white !important; border-color: #0056e0 !important; }
        .nintendo-active-style .filter-btn.active { background: #e60012 !important; color: white !important; border-color: #e60012 !important; }
        .xbox-active-style .filter-btn.active { background: #107c10 !important; color: white !important; border-color: #107c10 !important; }
        .pc-active-style .filter-btn.active { background: #616161 !important; color: white !important; border-color: #616161 !important; }
        .hardware-active-style .filter-btn.active { background: #ffcc00 !important; color: #000 !important; border-color: #ffcc00 !important; }

        /* Zoekbalk & Controls */
        .header-controls { display: flex; justify-content: center; align-items: center; gap: 15px; margin-bottom: 25px; margin-top: 20px; flex-wrap: wrap; }
        .search-container { position: relative; width: 100%; max-width: 500px; }
        #search-input { width: 100%; padding: 12px 45px 12px 20px; border-radius: 25px; border: 2px solid #333; background: #1e1e1e; color: white; font-size: 1em; outline: none; box-sizing: border-box; }
        #clear-search { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #666; font-size: 20px; cursor: pointer; display: none; }

        /* Info Button Styling */
        .info-btn { background: #1e1e1e; color: #00ffcc; border: 1px solid #333; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; font-weight: bold; font-family: serif; font-size: 18px; transition: 0.3s; }
        .info-btn:hover { background: #00ffcc; color: #121212; }

        /* Tabs & Filters */
        .tabs { display: flex; justify-content: center; gap: 8px; margin-bottom: 25px; flex-wrap: wrap; align-items: center; }
        .tab-button { background: #252525; color: white; border: 1px solid #333; padding: 10px 18px; cursor: pointer; border-radius: 8px; font-weight: bold; transition: 0.3s; }
        .tab-button.hardware-tab-special { margin-left: 25px; border-left: 3px solid #ffcc00; }
        
        .searching-active .filter-container { display: none !important; }
        .searching-active .group-section { background: transparent !important; border: none !important; padding: 0 !important; margin-bottom: 20px !important; }

        .console-content { display: none; background: #1e1e1e; padding: 20px; border-radius: 12px; text-align: left; margin-top: 10px; }
        .console-content.active, .console-content.searching { display: block; }
        
        /* Tabel Styling */
        .main-table { width: 100%; border-collapse: collapse; table-layout: fixed; margin-bottom: 20px; }
        .main-table thead { background: #2a2a2a; }
        .main-table th { padding: 12px; border-bottom: 2px solid #333; text-align: left; color: #00ffcc; text-transform: uppercase; font-size: 0.85em; letter-spacing: 1px; }
        .main-table td { padding: 12px; border-bottom: 1px solid #333; text-align: left; }
        .hardware-active-style .main-table th { color: #ffcc00; }

        .game-row.hidden, .group-section.hidden, .card.hidden, .grid-family-group.hidden { display: none !important; }
        .col-foto { width: 80px; text-align: center; }
        .col-prijs { width: 160px; }
        .game-thumb { width: 50px; height: auto; border-radius: 4px; }
        .hardware-thumb { width: 100px; height: auto; border-radius: 4px; }
        .digital-label { font-size: 0.8em; color: #888; margin-left: 5px; font-style: italic; }

        /* Tooltip & Wolkje */
        .extra-info-trigger { cursor: help; color: #00ffcc; position: relative; display: inline-block; margin-left: 5px; }
        .tooltip-text { 
            visibility: hidden; width: 180px; background-color: #000; color: #fff; text-align: center; 
            border: 1px solid #00ffcc; border-radius: 6px; padding: 8px; position: absolute; z-index: 100; 
            bottom: 150%; left: 50%; transform: translateX(-50%); opacity: 0; transition: opacity 0.3s; 
            font-size: 0.85em; font-weight: normal; 
        }
        .tooltip-text::after { content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px; border-width: 5px; border-style: solid; border-color: #00ffcc transparent transparent transparent; }
        .extra-info-trigger:hover .tooltip-text, .card:hover .tooltip-text { visibility: visible; opacity: 1; }

        /* Grid Layout Opschoning & Logica */
        .view-table .grid-container, .view-table .grid-family-title { display: none !important; }
        
        /* Grid Layout: Verberg Tabel-elementen */
        .view-grid .main-table { display: none !important; }
        
        /* Titels in Grid Layout */
        .view-grid .group-section h3 { display: block; } /* Toon titels per console */
        .view-grid .grid-family-title { display: block !important; } /* Toon familie-titels bij Hardware */

        /* SPECIFIEKE FIX: Verberg alles wat niet grid-related is als grid-view actief is */
        .view-grid .group-section:not(:has(.card)) { display: none !important; }
        .view-grid .group-section:not(:has(.card)) h3 { display: none !important; }

        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; padding: 20px 0; }
        .card { background: #252525; border-radius: 10px; padding: 18px; border: 1px solid #333; transition: 0.3s; position: relative; text-align: left; min-height: 100px; display: flex; flex-direction: column; justify-content: center; }
        .card:hover { border-color: #00ffcc; transform: translateY(-3px); }
        .card-console { font-size: 10px; color: #888; text-transform: uppercase; margin-bottom: 5px; display: block; }
        .card-title { font-weight: bold; font-size: 15px; color: #fff; line-height: 1.2; margin-bottom: 8px; }
        .card-price { color: #00ffcc; font-size: 14px; font-weight: bold; margin-top: auto; }
        .card-badges { position: absolute; top: 10px; right: 10px; display: flex; gap: 5px; }
        .badge { font-size: 9px; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
        .badge-info { background: #0070d1; color: #fff; }
        .badge-digital { background: #444; color: #fff; }

        .grid-family-title { font-size: 26px; font-weight: bold; margin-top: 30px; margin-bottom: 15px; border-bottom: 2px solid #333; padding-bottom: 10px; display: block; text-align: left; width: 100%; }
        .grid-family-count { font-size: 16px; color: #888; font-weight: normal; margin-left: 10px; }

        /* Modal */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); }
        .modal-content { background-color: #1e1e1e; margin: 5% auto; padding: 30px; border: 1px solid #00ffcc; border-radius: 15px; width: 85%; max-width: 800px; text-align: left; overflow-y: auto; max-height: 85vh; }
        .excel-layout { background: #000; color: #00ffcc; padding: 10px; border-radius: 5px; font-family: monospace; text-align: center; margin: 15px 0; border: 1px solid #333; }
        .excel-layout.hw { color: #ffcc00; border-color: #ffcc00; }
        .info-list li { margin-bottom: 10px; border-bottom: 1px solid #333; padding-bottom: 5px; list-style: none; }
        .info-list strong { color: #00ffcc; width: 120px; display: inline-block; }
        .info-list.hw strong { color: #ffcc00; }

        #backToTop { display: none; position: fixed; bottom: 30px; right: 30px; z-index: 99; border: none; outline: none; background-color: #00ffcc; color: black; padding: 15px; border-radius: 50%; width: 50px; height: 50px; font-size: 20px; font-weight: bold; box-shadow: 0px 4px 10px rgba(0,0,0,0.5); cursor: pointer; }
    </style>
</head>
<body class="view-table">

<div class="layout-switch" id="layout-switch">
    <button class="switch-btn active" id="btn-table" onclick="setLayout('table')">Tabel</button>
    <button class="switch-btn" id="btn-grid" onclick="setLayout('grid')">Grid</button>
</div>

<div id="infoModal" class="modal">
    <div class="modal-content">
        <span style="float:right; cursor:pointer; font-size:28px;" onclick="closeModal()">&times;</span>
        <p style="color: #00ffcc; font-weight: bold; margin-bottom: 20px;">De database moet een Excel-bestand (.xlsx) zijn.</p>
        <h3 style="color:#00ffcc; border-bottom: 1px solid #333;">üéÆ Games Bladen</h3>
        <p>Gebruik een blad per console of √©√©n verzamelblad met deze koppen:</p>
        <div class="excel-layout">Console | Game_Titel | Prijs | Digital | Extra</div>
        <ul class="info-list">
            <li><strong>Console:</strong> Systeemnaam (bijv. PS1, PS2, Switch, PC).</li>
            <li><strong>Game_Titel:</strong> Naam van het spel.</li>
            <li><strong>Prijs:</strong> Waarde marktprijs (bijv. 19.99).</li>
            <li><strong>Digital:</strong> Zet een <strong>x</strong> voor digitale games (icoon: üíæ).</li>
            <li><strong>Extra:</strong> Info (zoals "Enkel Disc"). Verschijnt als üí¨ bubbel.</li>
        </ul>
        <h3 style="color:#ffcc00; border-bottom: 1px solid #333; margin-top:20px;">üïπÔ∏è Hardware Blad</h3>
        <p>Maak een tabblad genaamd "Hardware" aan met deze koppen:</p>
        <div class="excel-layout hw">Hardware | Hardware_Titel | Prijs | Extra</div>
        <ul class="info-list hw">
            <li><strong>Hardware:</strong> Categorie (bijv. PS5, Xbox).</li>
            <li><strong>Hardware_Titel:</strong> Naam van het item (bijv. SCPH-7502).</li>
            <li><strong>Prijs:</strong> Waarde van het hardware item.</li>
            <li><strong>Extra:</strong> Informatie die direct in de tabel verschijnt.</li>
        </ul>
        <p style="margin-top: 20px; border-top: 1px solid #333; padding-top: 10px; color: #00ffcc; font-weight: bold;">üñºÔ∏è Logo Informatie</p>
        <p style="font-size: 0.95em;">Het script zoekt automatisch naar afbeeldingen in de map <code style="color:#00ffcc;">/Logo/</code>. De foto wordt <strong>automatisch toegepast</strong> als de bestandsnaam in de map exact overeenkomt met de <strong>Console</strong> of <strong>Hardware</strong> naam die je in Excel hebt ingevuld.</p>
    </div>
</div>

<div id="mySidebar" class="sidebar">
    <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
    <div class="sidebar-content"><h2 style="color: #00ffcc;">üìä Overzicht</h2><div id="sidebar-summary"></div></div>
</div>

<button class="openbtn" id="openbtn" onclick="openNav()" style="display:none;">&#9776; Overzicht</button>
<button id="backToTop" onclick="scrollToTop()">‚Üë</button>

<div class="container" id="main">
    <h1>üéÆ Mijn Game & Hardware Collectie</h1>
    <div class="upload-box" id="full-upload-box" style="padding: 40px; border: 2px dashed #00ffcc; border-radius: 15px; background: #1e1e1e; margin-bottom: 30px;">
        <h3>Database laden...</h3>
        <div class="header-controls">
            <label style="background: #1e1e1e; border: 1px solid #333; padding: 15px 30px; border-radius: 8px; cursor: pointer; color: #00ffcc;">üìÇ Handmatig Excel Selecteren<input type="file" id="upload-large" accept=".xlsx" style="display:none;"></label>
            <button class="info-btn" onclick="openModal()">i</button>
        </div>
    </div>
    <div class="header-controls" id="controls" style="display: none;">
        <div class="search-container">
            <input type="text" id="search-input" placeholder="Zoek door de hele collectie...">
            <button id="clear-search">&times;</button>
        </div>
        <div style="display:flex; gap:10px; align-items:center;">
            <label style="background: #1e1e1e; border: 1px solid #333; padding: 8px 15px; border-radius: 8px; cursor: pointer; color: #888; font-size: 0.8em;">üìÇ Wissel Database<input type="file" id="upload" accept=".xlsx" style="display:none;"></label>
            <button class="info-btn" onclick="openModal()">i</button>
        </div>
    </div>
    <div id="tabs" class="tabs"></div>
    <div id="content"></div>
</div>

<script>
    const searchInput = document.getElementById('search-input');
    const clearBtn = document.getElementById('clear-search');
    const bttBtn = document.getElementById("backToTop");
    const extensions = ['png', 'svg', 'webp', 'jpg', 'jpeg'];
    let lastActiveTabId = null;

    function setLayout(mode) {
        document.body.className = 'view-' + mode;
        document.getElementById('btn-table').classList.toggle('active', mode === 'table');
        document.getElementById('btn-grid').classList.toggle('active', mode === 'grid');
        if (searchInput.value.trim() !== "") applySearch();
    }

    function resetAllFilters() {
        document.querySelectorAll('.console-content').forEach(tabDiv => {
            tabDiv.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            tabDiv.querySelectorAll('.filter-btn-all').forEach(b => b.classList.add('active'));
            tabDiv.querySelectorAll('.group-section, .grid-family-group, .card').forEach(s => s.classList.remove('hidden'));
        });
    }

    function getFamilyInfo(name) {
        const n = name.toLowerCase();
        if (['ps', 'playstation', 'psp', 'vita'].some(m => n.includes(m))) return { label: 'PlayStation Family', style: 'ps-group', text: 'ps-text' };
        if (['nintendo', 'switch', 'ds', 'wii', 'gb', 'gba', 'gbc', 'nes', 'snes', 'cube', 'n64'].some(m => n.includes(m))) return { label: 'Nintendo World', style: 'nintendo-group', text: 'nintendo-text' };
        if (['xbox'].some(m => n.includes(m))) return { label: 'Xbox Family', style: 'xbox-group', text: 'xbox-text' };
        if (['pc', 'steam', 'epic', 'gog'].some(m => n.includes(m))) return { label: 'PC Gaming', style: 'pc-group', text: 'pc-text' };
        return { label: 'Overige Hardware', style: 'hardware-group', text: 'hardware-text' };
    }

    function getLogoPath(consoleName) {
        let name = (consoleName || "").trim();
        let lowerName = name.toLowerCase();
        if (lowerName === 'pc' || lowerName.includes('steam') || lowerName.includes('epic') || lowerName.includes('gog')) {
             if (lowerName.includes('steam')) name = 'STEAM'; else if (lowerName.includes('epic')) name = 'EPIC'; else if (lowerName.includes('gog')) name = 'GOG'; else name = 'PC';
        }
        return `Logo/${name}`;
    }

    function handleImgError(img, isHardware) {
        if (img.src.includes('TEMP-logo.webp') || img.src.includes('HARDWARE-logo.png')) { 
            img.onerror = null; 
            if (!isHardware && img.src.includes('TEMP-logo.webp')) img.style.visibility = 'hidden';
            return; 
        }
        let currentSrc = img.src;
        let baseWithExt = currentSrc.split('/').pop();
        let baseName = baseWithExt.substring(0, baseWithExt.lastIndexOf('.'));
        let currentExt = baseWithExt.split('.').pop().toLowerCase();
        let idx = extensions.indexOf(currentExt);
        if (idx !== -1 && idx < extensions.length - 1) img.src = `Logo/${baseName}.${extensions[idx + 1]}`;
        else { img.onerror = null; img.src = isHardware ? 'Logo/HARDWARE-logo.png' : 'Logo/TEMP-logo.webp'; }
    }

    window.onscroll = function() { bttBtn.style.display = (document.body.scrollTop > 300 || document.documentElement.scrollTop > 300) ? "block" : "none"; };
    function scrollToTop() { window.scrollTo({top: 0, behavior: 'smooth'}); }
    function openModal() { document.getElementById("infoModal").style.display = "block"; document.body.style.overflow = "hidden"; }
    function closeModal() { document.getElementById("infoModal").style.display = "none"; document.body.style.overflow = "auto"; }
    function openNav() { document.getElementById("mySidebar").style.width = "350px"; document.getElementById("main").style.marginLeft = "350px"; }
    function closeNav() { document.getElementById("mySidebar").style.width = "0"; document.getElementById("main").style.marginLeft = "auto"; }

    document.getElementById('upload').addEventListener('change', handleUpload);
    document.getElementById('upload-large').addEventListener('change', handleUpload);

    function handleUpload(e) {
        const reader = new FileReader();
        reader.onload = (ev) => processData(XLSX.read(new Uint8Array(ev.target.result), {type: 'array'}));
        reader.readAsArrayBuffer(e.target.files[0]);
    }

    function processData(workbook) {
        let games = []; let hardware = [];
        workbook.SheetNames.forEach(name => {
            const data = XLSX.utils.sheet_to_json(workbook.Sheets[name], { defval: "" });
            if (name.toLowerCase().includes("hardware") || name.toLowerCase().includes("consoles")) hardware = hardware.concat(data);
            else games = games.concat(data);
        });
        document.getElementById('full-upload-box').style.display = 'none';
        document.getElementById('controls').style.display = 'flex';
        document.getElementById('openbtn').style.display = 'block';
        document.getElementById('layout-switch').style.display = 'flex';
        render(games, hardware);
    }

    function render(games, hardware) {
        const tabs = document.getElementById('tabs');
        const content = document.getElementById('content');
        tabs.innerHTML = ""; content.innerHTML = "";
        const groups = {};
        games.forEach(row => { if(row.Console) { if (!groups[row.Console]) groups[row.Console] = { items: [] }; groups[row.Console].items.push(row); } });

        const families = [
            { name: "PlayStation Family", match: ['ps', 'playstation', 'psp', 'vita'], style: "ps-group", active: "ps-active" },
            { name: "Nintendo World", match: ['nintendo', 'switch', 'ds', 'wii', 'gb', 'gba', 'gbc', 'nes', 'snes', 'cube', 'n64'], style: "nintendo-group", active: "nintendo-active" },
            { name: "Xbox Family", match: ['xbox'], style: "xbox-group", active: "xbox-active" },
            { name: "PC Gaming", match: ['pc', 'steam', 'epic', 'gog'], style: "pc-group", active: "pc-active" }
        ];

        families.forEach((f, idx) => {
            const list = Object.keys(groups).filter(c => f.match.some(m => c.toLowerCase().includes(m))).sort();
            if(list.length > 0) createTab(f.name, list, groups, f.style, idx === 0, f.active, false);
        });

        if(hardware.length > 0) {
            const hwGroups = {};
            hardware.forEach(row => { const cat = row.Hardware || "Overig"; if(!hwGroups[cat]) hwGroups[cat] = { items: [] }; hwGroups[cat].items.push(row); });
            createTab("üïπÔ∏è Hardware", Object.keys(hwGroups).sort(), hwGroups, "hardware-group", false, "hardware-active", true);
        }
        updateSidebar(groups, hardware);
    }

    function createTab(title, consoleList, source, borderClass, isActive, activeClass, isHardware) {
        const id = 'tab-' + Math.random().toString(36).substr(2, 9);
        const btn = document.createElement('button');
        btn.className = 'tab-button' + (isActive ? ' ' + activeClass : '');
        if (isHardware) btn.classList.add('hardware-tab-special');
        btn.innerText = title;
        btn.dataset.tabId = id;
        btn.dataset.activeClass = activeClass;
        if (isActive) lastActiveTabId = id;

        btn.onclick = () => {
            if (searchInput.value.trim() !== "") return;
            lastActiveTabId = id;
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active', 'ps-active', 'nintendo-active', 'xbox-active', 'pc-active', 'hardware-active'));
            document.querySelectorAll('.console-content').forEach(c => { c.classList.remove('active'); c.style.display = 'none'; });
            btn.classList.add(activeClass);
            const target = document.getElementById(id);
            target.classList.add('active');
            target.style.display = 'block';
            resetAllFilters();
        };

        const div = document.createElement('div');
        div.id = id; div.className = 'console-content ' + activeClass.replace('-active', '-active-style');
        if (isActive) { div.classList.add('active'); div.style.display = 'block'; }

        const filterContainer = document.createElement('div');
        filterContainer.className = 'filter-container';
        filterContainer.style.cssText = "margin-bottom:20px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap;";
        
        const allBtn = document.createElement('button');
        allBtn.className = 'tab-button active filter-btn filter-btn-all';
        allBtn.innerText = "Toon Alles";
        allBtn.onclick = () => {
            filterContainer.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            allBtn.classList.add('active');
            div.querySelectorAll('.group-section, .grid-family-group, .card').forEach(s => s.classList.remove('hidden'));
        };
        filterContainer.appendChild(allBtn);

        if (isHardware) {
            const familyGroups = {};
            consoleList.forEach(name => {
                const info = getFamilyInfo(name);
                if (!familyGroups[info.label]) familyGroups[info.label] = { info, items: [] };
                familyGroups[info.label].items.push(...source[name].items);
            });

            const gridContainer = document.createElement('div');
            gridContainer.className = 'grid-container';
            Object.keys(familyGroups).forEach(fName => {
                const group = familyGroups[fName];
                if (group.items.length > 0) {
                    const groupHtml = `<div class="grid-family-group" data-family="${fName}" style="grid-column: 1 / -1;">
                        <span class="grid-family-title ${group.info.text}">${fName} <span class="grid-family-count">(${group.items.length} items)</span></span>
                    </div>` + group.items.map(i => {
                        const extraBadge = i.Extra ? `<div class="card-badges"><div class="badge badge-info">INFO</div><div class="tooltip-text">${i.Extra}</div></div>` : '';
                        return `<div class="card" data-title="${i.Hardware_Titel.toLowerCase()}" data-family="${fName}">${extraBadge}<span class="card-console">${i.Hardware}</span><span class="card-title">${i.Hardware_Titel}</span><span class="card-price">‚Ç¨ ${Number(i.Prijs||0).toFixed(2)}</span></div>`;
                    }).join('');
                    gridContainer.innerHTML += groupHtml;
                }
            });
            div.appendChild(gridContainer);

            Object.keys(familyGroups).forEach(fName => {
                if(familyGroups[fName].items.length > 0) {
                    const fBtn = document.createElement('button');
                    fBtn.className = 'tab-button filter-btn';
                    fBtn.innerText = fName.split(' ')[0];
                    fBtn.onclick = () => {
                        filterContainer.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                        fBtn.classList.add('active');
                        div.querySelectorAll('.group-section, .grid-family-group, .card').forEach(el => {
                            const match = el.dataset.family === fName;
                            el.classList.toggle('hidden', !match);
                        });
                    };
                    filterContainer.appendChild(fBtn);
                }
            });
        }

        consoleList.forEach(name => {
            if (!isHardware) {
                const fBtn = document.createElement('button');
                fBtn.className = 'tab-button filter-btn';
                fBtn.innerText = name;
                fBtn.onclick = () => {
                    filterContainer.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    fBtn.classList.add('active');
                    div.querySelectorAll('.group-section').forEach(s => s.classList.toggle('hidden', s.dataset.name !== name));
                };
                filterContainer.appendChild(fBtn);
            }

            const sec = document.createElement('div');
            const familyInfo = getFamilyInfo(name);
            sec.className = 'group-section ' + (isHardware ? familyInfo.style : borderClass);
            sec.dataset.name = name;
            sec.dataset.family = familyInfo.label;

            let items = [...source[name].items].sort((a,b) => ((isHardware ? a.Hardware_Titel : a.Game_Titel)||"").localeCompare((isHardware ? b.Hardware_Titel : b.Game_Titel)||""));
            
            let tableHeader = isHardware ? `<tr><th></th><th>Naam</th><th>Info</th><th>Prijs</th></tr>` : `<tr><th class="col-foto"></th><th>Titel</th><th class="col-prijs">Prijs</th></tr>`;
            let tableBody = items.map(i => {
                const title = isHardware ? i.Hardware_Titel : i.Game_Titel;
                const price = Number(i.Prijs||0).toFixed(2);
                if(isHardware) return `<tr class="game-row" data-title="${title.toLowerCase()}"><td class="col-foto"><img src="${getLogoPath(i.Hardware)}.png" class="hardware-thumb" onerror="handleImgError(this, true)"></td><td style="font-weight:bold;">${title}</td><td>${i.Extra || ""}</td><td style="color:#ffcc00; font-weight:bold;">‚Ç¨${price}</td></tr>`;
                else return `<tr class="game-row" data-title="${title.toLowerCase()}"><td class="col-foto"><img src="${getLogoPath(i.Console)}.png" class="game-thumb" onerror="handleImgError(this, false)"></td><td>${title}</td><td class="col-prijs">${i.Digital === 'x' ? '' : '‚Ç¨'+price}${i.Digital === 'x' ? ' üíæ <span class="digital-label">digital game</span>' : ''}${i.Extra ? `<span class="extra-info-trigger">üí¨<span class="tooltip-text">${i.Extra}</span></span>` : ''}</td></tr>`;
            }).join('');

            let gridHtml = !isHardware ? `<div class="grid-container">` + items.map(i => {
                const infoBadge = i.Extra ? `<div class="badge badge-info">INFO</div><div class="tooltip-text">${i.Extra}</div>` : '';
                const digitalBadge = i.Digital === 'x' ? `<div class="badge badge-digital">üíæ DIGITAL</div>` : '';
                return `<div class="card" data-title="${i.Game_Titel.toLowerCase()}"><div class="card-badges">${digitalBadge}${infoBadge}</div><span class="card-console">${i.Console}</span><span class="card-title">${i.Game_Titel}</span><span class="card-price">${i.Digital === 'x' ? 'Digital' : '‚Ç¨ ' + Number(i.Prijs||0).toFixed(2)}</span></div>`;
            }).join('') + `</div>` : '';

            sec.innerHTML = `<h3>${name}</h3><table class="main-table"><thead>${tableHeader}</thead><tbody>${tableBody}</tbody></table>${gridHtml}`;
            div.appendChild(sec);
        });
        div.prepend(filterContainer);
        tabs.appendChild(btn);
        content.appendChild(div);
    }

    function resetSearch() {
        searchInput.value = ""; clearBtn.style.display = "none";
        document.body.classList.remove('searching-active');
        document.querySelectorAll('.console-content').forEach(tabDiv => { 
            tabDiv.classList.remove('searching', 'active'); 
            tabDiv.style.display = 'none'; 
            tabDiv.querySelectorAll('.group-section, .game-row, .card, .grid-family-group').forEach(el => el.classList.remove('hidden')); 
        });
        document.querySelectorAll('.tab-button').forEach(b => b.style.opacity = "1");
        if (lastActiveTabId) {
            const activeBtn = document.querySelector(`[data-tab-id="${lastActiveTabId}"]`);
            const activeContent = document.getElementById(lastActiveTabId);
            if (activeBtn && activeContent) { activeBtn.classList.add(activeBtn.dataset.activeClass); activeContent.classList.add('active'); activeContent.style.display = 'block'; }
        }
    }

    function applySearch() {
        const term = searchInput.value.toLowerCase().trim();
        if (term === "") { resetSearch(); return; }
        clearBtn.style.display = "block";
        document.body.classList.add('searching-active');
        document.querySelectorAll('.console-content').forEach(tabDiv => {
            let tabMatch = false; 
            tabDiv.classList.add('searching');
            tabDiv.querySelectorAll('.group-section').forEach(sec => {
                let secMatch = false;
                sec.querySelectorAll('.game-row, .card').forEach(row => { 
                    const match = row.dataset.title.includes(term); 
                    row.classList.toggle('hidden', !match); 
                    if (match) secMatch = tabMatch = true; 
                });
                sec.classList.toggle('hidden', !secMatch);
            });
            tabDiv.querySelectorAll('.grid-family-group').forEach(g => g.classList.add('hidden'));
            const btn = document.querySelector(`[data-tab-id="${tabDiv.id}"]`);
            if (btn) btn.style.opacity = tabMatch ? "1" : "0.3";
            tabDiv.style.display = tabMatch ? 'block' : 'none';
        });
    }

    function updateSidebar(groups, hardware) {
        let totalVal = 0; let totalGames = 0;
        let html = `<table><tr><th>Systeem</th><th>Aantal</th><th>Waarde</th></tr>`;
        Object.keys(groups).sort().forEach(c => {
            const val = groups[c].items.reduce((s, g) => s + (g.Digital === 'x' ? 0 : Number(g.Prijs||0)), 0);
            totalVal += val; totalGames += groups[c].items.length;
            html += `<tr><td>${c}</td><td>${groups[c].items.length}</td><td>‚Ç¨${val.toFixed(2)}</td></tr>`;
        });
        const hwVal = hardware.reduce((s, h) => s + Number(h.Prijs||0), 0);
        html += `<tr style="color:#ffcc00;"><td>Hardware</td><td>${hardware.length}</td><td>‚Ç¨${hwVal.toFixed(2)}</td></tr><tr style="font-weight:bold; color:#00ffcc; border-top:2px solid #333;"><td>TOTAAL</td><td>${totalGames + hardware.length}</td><td>‚Ç¨${(totalVal+hwVal).toFixed(2)}</td></tr></table>`;
        document.getElementById('sidebar-summary').innerHTML = html;
    }

    searchInput.addEventListener('input', applySearch);
    clearBtn.onclick = resetSearch;
</script>
</body>
</html>
